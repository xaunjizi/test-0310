C51 COMPILER V9.52.0.0   UART1                                                             11/13/2024 09:06:20 PAGE 1   


C51 COMPILER V9.52.0.0, COMPILATION OF MODULE UART1
OBJECT MODULE PLACED IN .\obj\uart1.obj
COMPILER INVOKED BY: D:\keil\C51\BIN\C51.EXE src\uart1.c LARGE OMF2 BROWSE INCDIR(.\src) DEBUG PRINT(.\lst\uart1.lst) TA
                    -BS(2) OBJECT(.\obj\uart1.obj)

line level    source

   1          #include "CBM7216.h"
   2          #include "stdio.h"
   3          
   4          
   5          uint8 g_UTRBuffer[256] = 0;//´®¿ÚÊý¾Ýbuffer
   6          uint8 g_URLength = 0 , g_UTLength = 0 ;//Ö¡³¤¶È
   7          bit g_URXFlg=0;//Ö¡½ÓÊÕÍê³É±êÖ¾ 
   8          
   9          
  10          
  11          /*  
  12          function £º´®¿Ú³õÊ¼»¯
  13          parameter £º
  14            format £º
  15                bit6-5:00-ÎÞÐ£Ñé¡¢01ÆæÐ£Ñé¡¢10-Å¼Ð£Ñé¡¢11-ÆæÅ¼Ð£Ñé
  16                bit4£º0-Í£Ö¹Î»1bit¡¢1-Í£Ö¹Î»2bit
  17                bit3-0£ºÊý¾ÝÎ» 1000-8Î»¡¢0111-7Î»¡¢0110-6Î»¡¢0101-5Î»¡¢ÆäËû-½ûÖ¹
  18            bpr£ºUBPR = CLKUART1 / bpr - 1£»
  19              16M:  115200 - 0x8A
  20                            
  21          */
  22          void Uart1Init(uint8 format,uint16 bpr,uint16 timeoutcnt )
  23          {
  24   1          MDLCKCR_UART1EN = 1 << 4;   //Ê¹ÄÜ´®¿ÚÊ±ÖÓ
  25   1          UCR1 = 0;
  26   1        
  27   1          UTX1DMACR = 0 << 0;  //·¢ËÍÄ£Ê½Î»ÆÕÍ¨Ä£Ê½
  28   1          URX1DMACR = 0 << 0;  //½ÓÊÕÄ£Ê½Î»ÆÕÍ¨Ä£Ê½
  29   1          USETR1 = format ;
  30   1          UBPRL1 = (bpr & 0x00ff) >> 0;
  31   1          UBPRH1 = (bpr & 0xff00) >> 8;
  32   1          UCR1 = (0 << 2 ) | (1 << 1) | (1 << 0);       //²¨ÌØÂÊÒÀ¾ÝUBPRL/HÉèÖÃ¡¢Ê¹ÄÜ½ÓÊÕ¡¢Ê¹ÄÜ·¢ËÍ
  33   1          USR1 = 0x00;
  34   1          UIER1 = (0 << 7)|(1 << 6) |( 1 << 3);                  //ÆÕÍ¨Ä£Ê½·¢ËÍÍê³ÉÖÐ¶Ï½ûÖ¹Ê¹ÄÜ¡¢½ÓÊÕÍê³ÉÖÐ¶ÏÊ¹ÄÜ
             -¡¢Ö¡¼ä¸ô³¬Ê±Ê¹ÄÜ
  35   1          IRQ3ER_UART1INT = 1 << 2;                
  36   1          if(timeoutcnt>0)
  37   1          {
  38   2            URX1TMOUT=timeoutcnt;
  39   2            UCR1_RXTMOUTEN =(1<< 4);
  40   2          }
  41   1          EX3 = 1;
  42   1          EA = 1;
  43   1      }
  44          
  45          
  46          
  47          /*  
  48          function £º´®¿Ú·¢ËÍ1byteÊý¾Ý             
  49          */
  50          void UartSendByte(uint8 dat)
  51          {
  52   1        UTX1DR = dat; 
  53   1        while( 0x00 == USR1_TXDONE);   //µÈ´ý·¢ËÍÍê³É
C51 COMPILER V9.52.0.0   UART1                                                             11/13/2024 09:06:20 PAGE 2   

  54   1      }
  55          
  56          
  57          /*  
  58          function £º´®¿Ú·¢ËÍ×Ö·û´®             
  59          */
  60          void UartPrintf(uint8 *p)
  61          {
  62   1        while( *p != 0)           
  63   1        {
  64   2            UartSendByte(*(p++));
  65   2        }
  66   1      }
  67          
  68          /*  
  69          function £º°ÑÊý×Ö0-9×ª»¯³É   ASCLLÂëµÄ'0'-'9',         
  70          */
  71          void uartSendAsc(uint8 dat) {
  72   1      //   UartSendByte(dat+0x30);     //µÈÐ§ 0x30=48¶ÔÓ¦ASCLLµÄ'0'
  73   1           UartSendByte(dat+'0'); 
  74   1      }
  75          
  76          
  77          /*  
  78          function £º·¢ËÍASCLLÂëÊý×Ö´®,         
  79          */
  80          void Uart1SendAscNum(uint16 dat)
  81          {
  82   1         if(dat/10000 != 0)             uartSendAsc(dat/10000);
  83   1         if(dat%10000/1000 != 0)        uartSendAsc(dat%10000/1000);
  84   1         if(dat%10000%1000/100 != 0)    uartSendAsc(dat%10000%1000/100);
  85   1         if(dat%10000%1000%100/10 != 0) uartSendAsc(dat%10000%1000%100/10);
  86   1          uartSendAsc(dat%10);
  87   1      
  88   1      }
  89          
  90          
  91          /* 
  92          Ê®½øÖÆ×ª»¯Î»16½øÖÆ×Ö·ûÐÎÊ½·¢ËÍ   
  93          
  94          */
  95          char hexStr[]="0123456789ABCDEF";            //16½øÖÆ¶ÔÓ¦Âë±í
  96          void printDec2Hex(uint32 num)
  97          {
  98   1        char cs[9] , cs1[9] ;
  99   1        uint8 j = 8 , i = 8 ;
 100   1        
 101   1        do      
 102   1        {
 103   2          cs1[--i] = hexStr[num%16] ;  //¸ßÎ»¿ªÊ¼´æ£¬´®¿Ú´ÓµÍÎ»¿ªÊ¼·¢£¬ÔÚPC¸ÕºÃÏÔÊ¾¸ßÎ»ÔÚÇ°£¬µÍÎ»ÔÚºó
 104   2          num /= 16;
 105   2        }
 106   1        while(num);
 107   1        if(i%2) cs1[--i] = '0';        //×î¸ßÎ»²»Îª1ÔòÏÔÊ¾×Ö·û0
 108   1        
 109   1        cs1[8] = '\0';
 110   1        
 111   1        UartPrintf(&cs1[i]);    //´Ó×î¸ßÎ»i¿ªÊ¼·¢ËÍ£¬×î¸ßÎ»²»Ò»¶¨ÔÚµÚ0Î»
 112   1      }
*** WARNING C280 IN LINE 98 OF src\uart1.c: 'cs': unreferenced local variable
 113          
 114          
C51 COMPILER V9.52.0.0   UART1                                                             11/13/2024 09:06:20 PAGE 3   

 115          
 116          
 117          
 118          
 119          /*   ÖØ¶¨Ïòprintf£¨£©      */
 120          char putchar(char c)
 121          {
 122   1          UartSendByte(c);
 123   1          return c;
 124   1      
 125   1      }
 126          
 127          
 128          
 129          /*  
 130          function £º´®¿ÚMDA³õÊ¼»¯
 131          parameter £º
 132            format £º
 133                bit6-5:00-ÎÞÐ£Ñé¡¢01ÆæÐ£Ñé¡¢10-Å¼Ð£Ñé¡¢11-ÆæÅ¼Ð£Ñé
 134                bit4£º0-Í£Ö¹Î»1bit¡¢1-Í£Ö¹Î»2bit
 135                bit3-0£ºÊý¾ÝÎ» 1000-8Î»¡¢0111-7Î»¡¢0110-6Î»¡¢0101-5Î»¡¢ÆäËû-½ûÖ¹
 136            bpr£ºUBPR = CLKUART1 / bpr - 1£»
 137              48M:  115200 - 0x01A0¡¢19200 - 0x09C3¡¢9600 - 0x1387¡¢ 4800 - 0x270F
 138            txLengh£º·¢ËÍ»º³åÇø´óÐ¡   £¨×î´ó128byte£©
 139            rxLengh£º½ÓÊÕ»º³åÇø´óÐ¡
 140            tx_addr£ºDMA·¢ËÍÆðÊ¼µØÖ·  0x00-0x600(1536Byte)
 141            rx_addr£ºDMA½ÓÊÕÆðÊ¼µØÖ·  0x00-0x600(1536Byte)               
 142          */
 143          void Uart1DMAInit(uint8 format,uint16 bpr ,uint8 txLengh,uint8 rxLengh,uint16 tx_addr,uint16 rx_addr,uint8
             - timeoutcnt)
 144          {
 145   1          MDLCKCR_UART1EN = 1 << 4;   //Ê¹ÄÜ´®¿ÚÊ±ÖÓ
 146   1          UCR1 = 0;
 147   1          UTX1DMACR = ((txLengh-1) << 1) | (0x01);           //·¢ËÍ»º³åÇø´óÐ¡¡¢·¢ËÍÄ£Ê½Î»DMAÄ£Ê½
 148   1          UTX1DMAADDRL = (tx_addr & 0x00ff);          //DMA·¢ËÍÆðÊ¼µØÖ·
 149   1          UTX1DMAADDRH = (tx_addr & 0xff00) >> 8;
 150   1          URX1DMACR = ((rxLengh-1) << 1) |(0x01);           //½ÓÊÕ»º³åÇø´óÐ¡¡¢½ÓÊÕÄ£Ê½Î»DMAÄ£Ê½
 151   1          URX1DMAADDRL = (rx_addr & 0x00ff);           //DMA½ÓÊÕÆðÊ¼µØÖ·  
 152   1          URX1DMAADDRH = (rx_addr & 0xff00) >> 8;
 153   1          USETR1 = format ;
 154   1          UBPRL1 = (bpr & 0x00ff) >> 0;
 155   1          UBPRH1 = (bpr & 0xff00) >> 8;
 156   1          UCR1 = (0 << 2 ) | (1 << 1) | (1 << 0);       //²¨ÌØÂÊÒÀ¾ÝUBPRL/HÉèÖÃ¡¢Ê¹ÄÜ½ÓÊÕ¡¢Ê¹ÄÜ·¢ËÍ
 157   1          USR1 = 0x00;
 158   1          UIER1 = (0 << 5)|(1 << 4);                  //DMAÄ£Ê½·¢ËÍÍê³ÉÖÐ¶Ï½ûÖ¹Ê¹ÄÜ¡¢½ÓÊÕÍê³ÉÖÐ¶ÏÊ¹ÄÜ
 159   1          IRQ3ER_UART1INT = 1 << 2;
 160   1          if(timeoutcnt>0)
 161   1          {
 162   2            URX1TMOUT=timeoutcnt;
 163   2            UCR1_RXTMOUTEN =(1<< 4);
 164   2             UIER1|=0x08;
 165   2          }
 166   1          EX3 = 1;
 167   1          EA = 1;
 168   1      }
 169          
 170          
 171          /*  
 172          function ·¢ËÍÊ¹ÄÜ         
 173          */
 174          void Uart1DMATxEn(void)
 175          {
C51 COMPILER V9.52.0.0   UART1                                                             11/13/2024 09:06:20 PAGE 4   

 176   1          /*-----ÓÃ»§ÔÚ·¢ËÍÏÂÒ»Ö¡Ç°£¬ÏÈÔÚ´Ë½«Òª·¢ËÍµÄÊý¾ÝÖ¡Ð´Èëµ½·¢ËÍBufferÀï------*/
 177   1        
 178   1        USR1 = 0x40 ;//bit6£ºÐ´1Çå0²¢ÂíÉÏÆô¶¯·¢ËÍÏÂÒ»Ö¡Êý¾Ý£»  ²»¿É½øÐÐÎ»²Ù×÷
 179   1        UIER1_TXDONEIE = 0x20;//Ê¹ÄÜ·¢ËÍÍê³ÉÖÐ¶Ï
 180   1      }
 181          
 182          
 183          /*  
 184          function ½ÓÊÕÊ¹ÄÜ         
 185          */
 186          void Uart1DMARxEn(void)
 187          {
 188   1        /*-----ÓÃ»§ÔÚ½ÓÊÕÏÂÒ»Ö¡Êý¾ÝÇ°£¬ÏÈÔÚ´Ë¶Á³ö½ÓÊÕBufferÀïÒÑ¾­½ÓÊÕµ½µÄÊý¾ÝÖ¡------*/
 189   1        
 190   1        USR1 = 0x20 ;//bit5£ºÐ´1Çå0£¬²¢ÂíÉÏ¿ªÊ¼½ÓÊÕÏÂÒ»Ö¡Êý¾Ý,ÓÃ»§±ØÐèÔÚ½ÓÊÕÏÂÒ»Ö¡Êý¾ÝÖ®Ç°¶ÁÈ¡Íêµ±Ç°½ÓÊÕµ½µÄÊý¾ÝÖ
             -¡£¬·ñÔòÊý¾Ý½«±»¸²¸Ç
 191   1        UIER1_RXFULLIE = 0x10;//Ê¹ÄÜ½ÓÊÕÍê³ÉÖÐ¶Ï
 192   1      }
 193          
 194          
 195          
 196          


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    637    ----
   CONSTANT SIZE    =   ----    ----
   XDATA SIZE       =    275      37
   PDATA SIZE       =   ----    ----
   DATA SIZE        =   ----    ----
   IDATA SIZE       =   ----    ----
   BIT SIZE         =      1    ----
   EDATA SIZE       =   ----    ----
   HDATA SIZE       =   ----    ----
   XDATA CONST SIZE =   ----    ----
   FAR CONST SIZE   =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  1 WARNING(S),  0 ERROR(S)
